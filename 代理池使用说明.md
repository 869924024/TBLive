# 📡 智能代理池使用说明

## 🎯 功能简介

自动化 IP 代理池管理系统，支持：

- ✅ 自动计算所需 IP 数量
- ✅ 自动提取 IP（快代理 API）
- ✅ 自动测试 IP 可用性
- ✅ 失败自动重试补充
- ✅ 智能任务分配

## 📋 使用步骤

### 1. 配置代理 API

在 UI 界面中：

1. 选择 **"代理 API URL"** 选项
2. 填写快代理 API URL，例如：
   ```
   https://dps.kdlapi.com/api/getdps/?secret_id=xxx&signature=xxx&num=2&format=text&sep=1&f_auth=1&generateType=1
   ```

### 2. 配置任务参数

设置以下参数：

- **设备数据**：导入设备参数
- **账号数据**：导入账号 Cookie
- **操作倍数**：每个任务重复次数（通常设为 1）
- **每 IP 分配任务数**：每个 IP 处理多少个任务（**关键参数**）

### 3. 自动计算示例

**场景 1：1000 设备 × 3 账号 × 1 倍 = 3000 任务**

- 每 IP 分配：30
- 需要 IP：ceil(3000/30) = **100 个 IP**
- 任务分配：
  - 任务 0-29 → IP1
  - 任务 30-59 → IP2
  - 任务 60-89 → IP3
  - ...
  - 任务 2970-2999 → IP100

**场景 2：500 设备 × 2 账号 × 2 倍 = 2000 任务**

- 每 IP 分配：30
- 需要 IP：ceil(2000/30) = **67 个 IP**

**场景 3：100 设备 × 5 账号 × 1 倍 = 500 任务**

- 每 IP 分配：30
- 需要 IP：ceil(500/30) = **17 个 IP**

## 🔧 参数说明

### 每 IP 分配任务数

**推荐值**：30

**含义**：

- 每个 IP 最多处理多少个任务
- 影响提取的 IP 总数
- 快代理每个 IP 支持 **100 次/秒** 并发，**240 秒** 有效期

**如何选择**：

```
并发任务数 ÷ 每IP并发能力 = 每IP分配任务数

例如：
- 如果预计3秒内完成所有任务
- 快代理每IP支持100次/秒
- 每IP理论可处理：100 × 3 = 300任务
- 考虑安全余量：设置为30-50比较合适
```

### 常见配置

| 总任务数 | 每 IP 分配 | 需要 IP 数 | 说明                    |
| -------- | ---------- | ---------- | ----------------------- |
| 3000     | 30         | 100        | 标准配置                |
| 3000     | 50         | 60         | 更少 IP，每 IP 压力稍大 |
| 3000     | 20         | 150        | 更多 IP，每 IP 压力更小 |
| 1000     | 30         | 34         | 小规模任务              |
| 10000    | 30         | 334        | 大规模任务              |

## 📊 运行流程

```
┌─────────────────────────┐
│  1. 点击"开始任务"      │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  2. 计算需要的IP数量    │
│     公式：ceil(总任务/每IP) │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  3. 从快代理提取IP      │
│     自动调用API获取     │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  4. 并发测试IP可用性    │
│     测试URL: taobao.com │
│     超时：3秒           │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  5. 失败IP自动补充      │
│     最多重试3次         │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  6. 智能分配任务        │
│     每个任务自动分配IP  │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  7. 开始执行任务        │
│     突发模式并发发送    │
└─────────────────────────┘
```

## ⚠️ 注意事项

### 1. 快代理限制

- ✅ 每个 IP：100 次/秒并发
- ✅ 有效期：240 秒
- ⚠️ 确保账户余额充足

### 2. 任务分配逻辑

```python
# 任务索引 → IP索引
ip_index = task_index // tasks_per_ip

# 例如 tasks_per_ip = 30:
任务0-29   → IP0
任务30-59  → IP1
任务60-89  → IP2
...
```

### 3. 代理格式

快代理返回格式：

```
IP:PORT:USERNAME:PASSWORD

例如：
122.96.255.236:27986:d3884991709:sdcfvni9
58.19.55.9:13614:d3884991709:sdcfvni9
```

### 4. 错误处理

- ❌ **提取失败**：自动重试（最多 3 次）
- ❌ **测试失败**：该 IP 丢弃，继续提取
- ❌ **数量不足**：使用现有可用 IP 继续执行

## 🧪 测试方法

运行测试脚本：

```bash
python test_proxy_manager.py
```

测试内容：

1. IP 需求计算
2. IP 提取功能
3. IP 测试功能
4. 任务分配逻辑
5. 完整初始化流程（可选）

## 📈 性能优化建议

### 最佳实践

1. **合理设置每 IP 分配数**

   - 小任务（<1000）：20-30
   - 中任务（1000-5000）：30-50
   - 大任务（>5000）：30-40

2. **避免过度提取**

   - 不要设置过小的每 IP 分配数
   - 每个 IP 都有成本，避免浪费

3. **监控成功率**
   - 观察任务成功率
   - 如果失败率高，减少每 IP 分配数

## 🔍 调试信息

运行时会在日志中显示：

```
========================================
🌐 开始初始化代理池...
📊 总任务数: 3000
📌 每IP分配任务数: 30
🔌 正在从快代理提取 100 个IP...
✅ 成功提取 100 个IP
🧪 开始测试 100 个代理...
✅ 测试完成: 可用 98/100, 失败 2
🔄 第 2 次提取 (需要 2 个)...
🔌 正在从快代理提取 2 个IP...
✅ 成功提取 2 个IP
🧪 开始测试 2 个代理...
✅ 测试完成: 可用 2/2, 失败 0
✅ 代理池初始化成功！
========================================
📊 代理分配统计
========================================
总代理数: 100
每IP任务数: 30
总任务容量: 3000
----------------------------------------
  1. 122.96.255.236 →  30 任务
  2. 58.19.55.9     →  30 任务
  ...
========================================
```

## 💡 常见问题

### Q1: 为什么需要这么多 IP？

**A:** 避免单个 IP 压力过大被封禁，分散请求更安全。

### Q2: 每 IP 分配数设置多少合适？

**A:** 推荐 30，既不浪费 IP，也不会压力过大。

### Q3: IP 测试为什么会失败？

**A:** 可能原因：

- IP 本身不可用
- 网络问题
- 测试 URL 被封
- 代理认证失败

### Q4: 如果 IP 数量不足会怎样？

**A:** 系统会使用已有的可用 IP 继续执行，但可能影响效率。

### Q5: 能否不使用代理池？

**A:** 可以，选择"直接填写代理"即可使用固定代理。

## 📞 技术支持

如遇问题，请检查：

1. 快代理 API URL 是否正确
2. 快代理账户余额是否充足
3. 网络连接是否正常
4. 日志中的错误信息

---

**版本**：v1.0  
**更新时间**：2025-10-28  
**作者**：Claude AI Assistant
